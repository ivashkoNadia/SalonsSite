<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8"/>
    <title>Записи</title>
    <link rel="stylesheet" href="Appointment.css">
</head>

<body>
    <div class="header">
        <div class="purple-bar">
            <button onclick="window.location.href='MainPage.html'" class="pink-button">Головне меню</button>
            <button id="myAccountButton" class="pink-button">Мій акаунт</button>
        </div>
    </div>
    <div  id = "appointments"></div>

<script src="mainpage.js"></script>
    <script>
        function getAppointments() {
            if (!sessionStorage.getItem('user')) {
                alert('Будь ласка, увійдіть в систему.');
                return;
            }
            var user_id = sessionStorage.getItem('user');
            var data = {
                user_id: user_id
            };

            var xhr = new XMLHttpRequest();
            xhr.open("POST", "http://127.0.0.1:5000/user_appointments");
            xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");

            xhr.onreadystatechange = function() {
                if (xhr.readyState === XMLHttpRequest.DONE) {
                    if (xhr.status === 200) {
                        var response = JSON.parse(xhr.responseText);
                        var appointments = response.appointments;
                        displayAppointments(appointments);
                } 
                else { alert('Помилка отримання записів'); }
                }
            };

            xhr.send(JSON.stringify(data));
            
        }

        function displayAppointments(appointments){
            var AppoDiv = document.getElementById('appointments');


            var headings = ['Дата', 'Салон', 'Вулиця', 'Послуга', '']; // Empty string for cancel button
            var headingContainer = document.createElement('div');
            headingContainer.classList.add('name-container');
            headings.forEach(function(headingText) {
                var heading = document.createElement('div');
                heading.classList.add('appointment-column');
                heading.textContent = headingText;
                headingContainer.appendChild(heading);
            });
            AppoDiv.appendChild(headingContainer);


            appointments.forEach(function(appointmentsItem) {
                var appoContainer = document.createElement('div');
                appoContainer.classList.add('appointment-container');

                // Додаємо дату
                var dateElement = document.createElement('div');
                dateElement.classList.add('appointment-date');
                dateElement.textContent = appointmentsItem.datetime
                appoContainer.appendChild(dateElement);

                var salonElement = document.createElement('div');
                salonElement.classList.add('appointments-salon');
                salonElement.textContent =  appointmentsItem.salon_name;
                appoContainer.appendChild(salonElement);

                var streetElement = document.createElement('div');
                streetElement.classList.add('appointments-street');
                streetElement.textContent = "⟟ "+ appointmentsItem.salon_street;
                appoContainer.appendChild(streetElement);

                var serviceElement = document.createElement('div');
                serviceElement.classList.add('appointments-service');
                serviceElement.textContent = appointmentsItem.service_name;
                appoContainer.appendChild(serviceElement);

                var cancelButton = document.createElement('button');
                cancelButton.classList.add('cancel-button');
                cancelButton.textContent = "Скасувати";
                cancelButton.addEventListener("click", function() {
                    var appoId = appointmentsItem.appointment_id;
                    sessionStorage.setItem('appointment', appoId);
                    deleteAppointments();
                });
                //cancelButton.setAttribute("data-salon-id", "{{ salon.id }}"); 
                appoContainer.appendChild(cancelButton);

                //Додаємо контейнер до основного контейнера
                AppoDiv.appendChild(appoContainer);
            });
        }

       function deleteAppointments() {
            var appo_id = sessionStorage.getItem('appointment');
            var xhr = new XMLHttpRequest();
            xhr.open("DELETE", "http://127.0.0.1:5000/delete_appointment/" + appo_id);
            xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");

            xhr.onreadystatechange = function() {
                if (xhr.readyState === XMLHttpRequest.DONE) {
                    if (xhr.status === 200) {
                        var response = JSON.parse(xhr.responseText);
                        var message = response.message;
                        alert(message);
                        window.open('Appointment.html', '_self'); // Відкрити сторінку у тому ж вікні
                    } else {  alert('Помилка видалення'); }
                }
            };

            xhr.send();
        }



// Виклик функції при завантаженні сторінки
getAppointments();

    </script>

</body>
</html>