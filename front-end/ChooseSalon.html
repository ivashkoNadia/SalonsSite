<!DOCTYPE html>
<html>

<head>
    <meta charset="UTF-8"/>
    <title>My page</title>
    <link rel="stylesheet" href="ChooseSalon.css">
</head>

<body>
    <div class="header">
        <div class="purple-bar">
            <button onclick="window.location.href='MainPage.html'" class="pink-button">Головне меню</button>
            <button id="myAccountButton" class="pink-button">Мій акаунт</button>
            <button class="pink-button" onclick="window.location.href='Appointment.html'" >Мої записи</button>
        </div>
    </div>

    <div id="salonDetails" >
        <span class = salonName  id="salonName"></span><br>
        <span class =salonDistrict id="salonDistrict"></span><br>
        <span class = salonStreet id="salonStreet"></span><br>
        <span class = salonRating id="salonRating"></span><br>
        <span class = salonSocial id="salonSocial"></span><br>
    </div>

    <form id="registrationForm" class="registrationForm">
        <div class="reserv-title">Здійснити запис</div>
        <label for="procedure">Оберіть процедуру:</label>
        <select id="procedure" name="procedure">
            <!-- Опції для випадаючого списку процедур -->
        </select><br><br>

        <label for="date">Оберіть дату:</label>
        <input type="date" id="date" name="date"><br><br>

        <label for="time">Оберіть час:</label>
        <!-- <input type="time" id="time" name="time"><br><br> -->
        <select id="time" name="time">
            <option value="09:00">09:00</option>
            <option value="11:00">11:00</option>
            <option value="13:00">13:00</option>
            <option value="15:00">15:00</option>
            <option value="17:00">17:00</option>
            <option value="19:00">19:00</option>
        </select>

        <button class = "reserv-button" type="button" onclick="register()">Записатися</button>
    </form>

<div class="cont1_cont2">
    <div class="cont1">
        <div class="feedback-div">
        <textarea class="feedback-input" id ="text_feedback" placeholder="Напишіть свій відгук тут..."></textarea>
        <div>
        <div class="rating">
        <span class="star" data-value="1">&#9733;</span>
        <span class="star" data-value="2">&#9733;</span>
        <span class="star" data-value="3">&#9733;</span>
        <span class="star" data-value="4">&#9733;</span>
        <span class="star" data-value="5">&#9733;</span>
        </div>
        <button id="submitBtn" class="reserv-button">Відправити</button>
        </div>

        </div>
    </div>

    <div class="cont2">
    <div class="feedback-title">Відгуки</div>
    <div class="feedback-text" id="feedback-text"></div>
    </div>
</div>


    <script src="mainpage.js"></script>
    <script>
        function getSalon() {
            // Отримати ідентифікатор салону з sessionStorage
            var salonId = sessionStorage.getItem('salon');

            // Перевірка, чи отримано ідентифікатор салону
            if (salonId) {
                var data = {
                    salon_id: salonId
                };

                var xhr = new XMLHttpRequest();
                xhr.open("POST", "http://127.0.0.1:5000/salon_details");
                xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
                xhr.onreadystatechange = function() {
                    if (xhr.readyState === XMLHttpRequest.DONE) {
                        if (xhr.status === 200) {
                            var response = JSON.parse(xhr.responseText);
                            var salon = response.salon;

                            // Відображення отриманих даних на сторінці у відповідних <span> елементах
                            document.getElementById("salonDistrict").textContent = "⚲ " + salon.district+" р-н";
                            document.getElementById("salonName").textContent =  salon.name;
                            document.getElementById("salonRating").textContent = "Рейтинг: " + salon.rating.toFixed(1) + "☆";
                            document.getElementById("salonStreet").textContent =  "Вул."+salon.street;
                            document.getElementById("salonSocial").textContent = "Соціальні мережі ⌕: " + salon.social;

                            var photoPlace = document.createElement("div");
                            photoPlace.classList.add("photo-place");
                            document.getElementById("salonDetails").appendChild(photoPlace);
                            if (salon.photo) {
                                var img = document.createElement('img');
                                img.src = "data:image/jpeg;base64," + salon.photo;
                                photoPlace.appendChild(img);
                            }

                        } else {
                            console.error('Помилка отримання даних з сервера. Статус:', xhr.status);
                        }
                    }
                };

                xhr.send(JSON.stringify(data));
            } else {
                console.error('Ідентифікатор салону не був збережений у sessionStorage');
            }
        }

        function get_services_in_Salon() {
    // Отримати ідентифікатор салону з sessionStorage
    var salonId = sessionStorage.getItem('salon');

    // Перевірка, чи отримано ідентифікатор салону
    if (salonId) {
        var data = {
            salon_id: salonId
        };

        // Надіслати запит на сервер
        fetch('http://127.0.0.1:5000/salon_services', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {

            var procedureSelect = document.getElementById('procedure');

             // Створення першого елемента списку зі значенням "-"
            var defaultOption = document.createElement('option');
            defaultOption.value = 0;
            defaultOption.textContent = '-';
            procedureSelect.appendChild(defaultOption);

            // Додавання опцій з отриманими даними
            data.services.forEach(service => {
                var option = document.createElement('option');
                option.value = service.name;//here was id
                option.textContent = service.name;
                procedureSelect.appendChild(option);
            });


            // Отримання таблиці для відображення даних
            var table = document.createElement('table');
            table.classList.add('services-table');
            // Створення заголовка таблиці
            var headerRow = table.insertRow();
            var nameHeader = headerRow.insertCell();
            nameHeader.textContent = 'Процедура';
            var priceHeader = headerRow.insertCell();
            priceHeader.textContent = 'Ціна';
            // Додавання отриманих даних до таблиці
            data.services.forEach(service => {
                var row = table.insertRow();
                var nameCell = row.insertCell();
                nameCell.textContent = service.name;
                var priceCell = row.insertCell();
                priceCell.textContent = service.price;

            });

            // Додавання таблиці на сторінку
            document.body.appendChild(table);

            var mes = document.createElement('p');
            mes.textContent="*Вказано мінімальну ціну за послугу";
            mes.classList.add('remark-table');
            document.body.appendChild(mes); 
        })
        .catch(error => console.error('Error:', error));
    } else {
        console.error('Ідентифікатор салону не був збережений у sessionStorage');
    }
}




        getSalon();
        get_services_in_Salon();



        function register() {
            if (!sessionStorage.getItem('user')) {
        alert('Будь ласка, увійдіть в систему.');
        // Якщо 'user' відсутній, можна виконати подальші дії, або просто вийти з функції
        return;
    }

    // Отримуємо дані з форми
    var procedure = document.getElementById("procedure").value;
    var date = document.getElementById("date").value;
    var time = document.getElementById("time").value;

    // Отримуємо user_id з sessionStorage
    var userId = sessionStorage.getItem('user');

    // Отримуємо salon_id з sessionStorage
    var salonId = sessionStorage.getItem('salon');

    if ((!userId || !salonId || !procedure || !date || !time) ||(procedure==0)) {
        alert("Будь ласка, заповніть всі поля форми.");
        return;
    }

    // Формуємо об'єкт з даними
    var data = {
        user_id: userId,
        salon_id: salonId,
        service_name: procedure,
        datetime: date + " " + time
    };

    // Відправляємо дані на сервер
    var xhr = new XMLHttpRequest();
    xhr.open("POST", "http://127.0.0.1:5000/add_appointment");
    xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
    xhr.onreadystatechange = function () {
        if (xhr.readyState === XMLHttpRequest.DONE) {
            if (xhr.status === 200) {
                var response = JSON.parse(xhr.responseText);
                if (response.message) {
                    alert(response.message);
                }
                 else {
                    alert(response.error);
                }
            } else {
                alert("Помилка під час реєстрації. Спробуйте ще раз.");
            }
        }
    };
    xhr.send(JSON.stringify(data));
}


function addFeedback() {
    if (!sessionStorage.getItem('user')) {
        alert('Будь ласка, увійдіть в систему.');
        // Якщо 'user' відсутній, можна виконати подальші дії, або просто вийти з функції
        return;
    }

    // Отримання значень з поля введення тексту відгуку та рейтингу
    var text = document.getElementById('text_feedback').value;
    var rating = selectedStar; // Використовуємо значення змінної, яку ми визначили раніше

    if (!rating) {
        alert('Будь ласка, виберіть кількість зірок.');
        return;
    }

    // Отримання ідентифікатора користувача та салону з sessionStorage
    var user_id = sessionStorage.getItem('user');
    var salon_id = sessionStorage.getItem('salon');

    // Створення об'єкту з даними
    var data = {
        user_id: user_id,
        text: text,
        rating: rating,
        salon_id: salon_id
    };

   // Відправляємо дані на сервер
    var xhr = new XMLHttpRequest();
    xhr.open("POST", "http://127.0.0.1:5000/add_feedback");
    xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");
    xhr.onreadystatechange = function () {
        if (xhr.readyState === XMLHttpRequest.DONE) {
            if (xhr.status === 200) {
                var response = JSON.parse(xhr.responseText);
                if (response.message) {
                    alert(response.message);
                    window.location.href = "ChooseSalon.html";
                }
                 else {
                    alert(response.error);
                }
            } else {
                alert("Помилка під час реєстрації. Спробуйте ще раз.");
            }
        }
    };
    xhr.send(JSON.stringify(data));

     document.getElementById('text_feedback').value = '';
    
    // Очищення вибраної зірки
    selectedStar = 0;
    highlightStars(selectedStar);
}





const stars = document.querySelectorAll('.star');
let selectedStar = 0;

stars.forEach(star => {
  star.addEventListener('click', () => {
    const value = parseInt(star.getAttribute('data-value'));
    selectedStar = value;
    highlightStars(value);
  });
});

function highlightStars(value) {
  stars.forEach((star, index) => {
    if (index < value) {
      star.style.color = '#352961';
    } else {
      star.style.color = '#f6e5e5';
    }
  });
}

document.getElementById('submitBtn').addEventListener('click', addFeedback);


// Функція, що відображає відгуки на сторінці
function displayFeedback(feedback) {
    var feedbackDiv = document.getElementById('feedback-text');


    // Ітерація по кожному відгуку
    feedback.forEach(function(feedbackItem) {
        // Створення контейнера для відгуку
        var feedbackContainer = document.createElement('div');
        feedbackContainer.classList.add('feedback-container');

        // Додаємо дату
        var dateElement = document.createElement('div');
        dateElement.classList.add('feedback-date');
        dateElement.textContent = feedbackItem.datetime.split(' ')[0]; // Отримуємо дату (без часу)
        feedbackContainer.appendChild(dateElement);

        // Додаємо рейтинг
        var ratingElement = document.createElement('div');
        ratingElement.classList.add('feedback-rating');
        ratingElement.textContent = 'Оцінка ☆: ' + feedbackItem.rating;
        feedbackContainer.appendChild(ratingElement);

        // Додаємо текст відгуку
        var textElement = document.createElement('div');
        textElement.classList.add('feedback-text');
        textElement.textContent = feedbackItem.text;
        feedbackContainer.appendChild(textElement);

        // Додаємо контейнер відгуку до основного контейнера
        feedbackDiv.appendChild(feedbackContainer);
    });
}

// Функція для відправки запиту на сервер за відгуками
function getFeedback() {
    var salonId = sessionStorage.getItem('salon');

    // Перевірка наявності ідентифікатора салону
    if (salonId) {
        var data = {
            salon_id: salonId
        };

        var xhr = new XMLHttpRequest();
        xhr.open("POST", "http://127.0.0.1:5000/salon_feedback");
        xhr.setRequestHeader("Content-Type", "application/json;charset=UTF-8");

        xhr.onreadystatechange = function() {
            if (xhr.readyState === XMLHttpRequest.DONE) {
                if (xhr.status === 200) {
                    var response = JSON.parse(xhr.responseText);
                    var feedback = response.feedback;
                    displayFeedback(feedback);

                } else {
                    alert('Помилка отримання відгуків');
                }
            }
        };

        xhr.send(JSON.stringify(data));
    } else {
        alert('Ідентифікатор салону не знайдено');
    }
}

// Виклик функції при завантаженні сторінки
getFeedback();



    </script>
</body>

</html>


